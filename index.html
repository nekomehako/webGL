<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>WebGL TEST</title>
        <script src="script.js" type="text/javascript"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
        <script src="gui.js" type="text/javascript"></script>

        <script id="vs" type="vertex-shader">#version 300 es
            in vec3 vPos;
            out vec2 fragCoord;
            out vec2 texCoord;
            void main() {
                fragCoord = (vPos.xy + vec2(1., 1.))/2.;
                texCoord = vec2(fragCoord.x, 1. - fragCoord.y);
                gl_Position = vec4(vPos, 1.);
            }
        </script>
        <script id="fs" type="fragment-shader">#version 300 es
            precision highp float;
            in vec2 fragCoord;
            in vec2 texCoord;
            layout (location = 0) out vec4 fragColor;
            uniform vec2 resolution;
            uniform vec2 omouse;
            uniform vec2 mouse;
            uniform float mousePress;
            uniform float time;
            uniform sampler2D previous;
            uniform sampler2D tex;

            vec2 norCoord(vec2 coord, vec2 resolution){
                vec2 temp = coord * 2. - 1.;
                return vec2(temp.x * resolution.x,temp.y * resolution.y)/min(resolution.x,resolution.y);
            }
            void main() {
                vec2 uv = norCoord(fragCoord, resolution);
                vec2 tex_nor = norCoord(texCoord, resolution);
                vec2 mouse_nor = norCoord(mouse, resolution);
                vec3 mcol = vec3(step(0.2, length(uv - mouse_nor)));
                vec3 col = (mcol + texture(previous, fragCoord).xyz*2. + texture(tex, vec2(tex_nor.x+time/10., tex_nor.y)).xyz)/4.0;
                fragColor = vec4(col, 1.-mousePress);
            }
        </script>
        <script id="fssave" type="fragment-shader">#version 300 es
            precision highp float;
            in vec2 fragCoord;
            layout (location = 0) out vec4 fragColor;
            uniform sampler2D previous;

            void main() {
                fragColor = texture(previous, fragCoord);
            }
        </script>
        <script id="fsp" type="fragment-shader">#version 300 es
            precision highp float;
            in vec2 fragCoord;
            layout (location = 0) out vec4 fragColor;
            uniform float param1;
            uniform float time;
            uniform vec2 resolution;
            uniform sampler2D previous;
            float rand(float n){return fract(sin(n) * 43758.5453123);}

            float glitch(float axis, float p, float h){
                return step(p-h, axis)*step(axis, h+p);
            }
            vec2 hash( vec2 p ) // replace this by something better
            {
                p = vec2( dot(p,vec2(127.1,311.7)), dot(p,vec2(269.5,183.3)) );
                return -1.0 + 2.0*fract(sin(p)*43758.5453123);
            }
            float sNoise( in vec2 p )
            {
                const float K1 = 0.366025404; // (sqrt(3)-1)/2;
                const float K2 = 0.211324865; // (3-sqrt(3))/6;
            
                vec2  i = floor( p + (p.x+p.y)*K1 );
                vec2  a = p - i + (i.x+i.y)*K2;
                float m = step(a.y,a.x); 
                vec2  o = vec2(m,1.0-m);
                vec2  b = a - o + K2;
                vec2  c = a - 1.0 + 2.0*K2;
                vec3  h = max( 0.5-vec3(dot(a,a), dot(b,b), dot(c,c) ), 0.0 );
                vec3  n = h*h*h*h*vec3( dot(a,hash(i+0.0)), dot(b,hash(i+o)), dot(c,hash(i+1.0)));
                return dot( n, vec3(70.0) );
            }
            void main() {
                float t = time;//ceil(time*0.5);
                float mask = step(0.998, rand(fragCoord.x+t))+step(0.999, rand(ceil(fragCoord.x*resolution.x/3.)/resolution.x+t));
                float siny = sin(fragCoord.y*10.+time*100.)*0.001;
                float g = glitch(fragCoord.y, rand(fragCoord.x +t-13.), rand(fragCoord.x+ siny +t+54.)*0.4);
                
                vec3 luma = vec3(0.299, 0.587, 0.114);
                vec2 norCoord = fragCoord-0.5;
                vec2 norResolution = resolution/min(resolution.x, resolution.y);
                vec2 uv = norCoord * norResolution;

				float vignet = length(fragCoord-0.5);
				vec2 distord = norCoord / (1. - vignet * 0.3);
				vec2 texUV = distord*0.8+0.5;
                float n = sNoise((uv + ceil(t*90.))*40.)*sNoise((uv+ ceil(t*60.))*20.);
                //vec3 col = vec3(mask);

                vec3 col = texture(previous, texUV+siny).xyz * (1. - g * mask);
                fragColor.xyz = vec3(smoothstep(0.1, 0.8, dot(col, luma))*0.5+0.5- length(distord)-step(0.5, n));
                fragColor.w = 1.0;
            }
        </script>
        <style type="text/css">
            body{
                margin : 0px ;
                padding : 0px ;
            }
            body #wrapper{
                width: 100%;
                height: 100%;
                position: fixed;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <canvas id="canvas"></canvas>
        </div>
    </body>
</html>