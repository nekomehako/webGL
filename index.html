<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>WebGL TEST</title>
        <script src="script.js" type="text/javascript"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
        <script src="gui.js" type="text/javascript"></script>

        <script id="vs" type="vertex-shader">#version 300 es
            in vec3 vPos;
            out vec2 fragCoord;
            out vec2 texCoord;
            void main() {
                fragCoord = (vPos.xy + vec2(1., 1.))/2.;
                texCoord = vec2(fragCoord.x, 1. - fragCoord.y);
                gl_Position = vec4(vPos, 1.);
            }
        </script>
        <script id="fs" type="fragment-shader">#version 300 es
            precision highp float;
            in vec2 fragCoord;
            in vec2 texCoord;
            layout (location = 0) out vec4 fragColor;
            uniform vec2 resolution;
            uniform vec2 omouse;
            uniform vec2 mouse;
            uniform float mousePress;
            uniform float time;
            uniform sampler2D previous;
            uniform sampler2D tex;

            vec2 norCoord(vec2 coord, vec2 resolution){
                vec2 temp = coord * 2. - 1.;
                return vec2(temp.x * resolution.x,temp.y * resolution.y)/min(resolution.x,resolution.y);
            }
            void main() {
                vec2 uv = norCoord(fragCoord, resolution);
                vec2 tex_nor = norCoord(texCoord, resolution);
                vec2 mouse_nor = norCoord(mouse, resolution);
                vec3 mcol = vec3(step(0.2, length(uv - mouse_nor)));
                vec3 col = (mcol + texture(previous, fragCoord).xyz*2. + texture(tex, vec2(tex_nor.x, tex_nor.y)).xyz)/4.0;
                fragColor.xyz = col;
                fragColor.w = 1.;
            }
        </script>
        <script id="fssave" type="fragment-shader">#version 300 es
            precision highp float;
            in vec2 fragCoord;
            layout (location = 0) out vec4 fragColor;
            uniform sampler2D previous;

            void main() {
                fragColor = texture(previous, vec2(fragCoord.x, fragCoord.y));
            }
        </script>
        <script id="fsp" type="fragment-shader">#version 300 es
            precision highp float;
            in vec2 fragCoord;
            layout (location = 0) out vec4 fragColor;
            uniform sampler2D previous;
            uniform float binarization;
            uniform vec2 lightPos;
            uniform vec2 lightTarget;
            uniform vec2 resolution;

            float luminance(vec3 RGB){
                return dot(RGB, vec3(0.299, 0.587, 0.114));
            }
            // Interleaved gradient noise
            float ilg_noise(vec2 p){
                return fract(52.9829189 * fract(dot(vec2(0.06711056, 0.00583715), p)));
            }

            vec3 radialBlur(sampler2D tex, vec2 fragCoord, vec2 lightDir, float distance){
                vec2 uv = ((fragCoord) * 2.) -1.;
                float resolution_nrml = min(resolution.x, resolution.y);
                vec3 col = vec3(0.);
                for(float d = 1.; d < distance; d += 0.05){
                    vec2 coord = (uv / d - lightDir*(1.-1./d) + 1.) * 0.5;
                    vec3 temp = texture(tex, coord).xyz;
                    float lum = luminance(temp);
                    col += step(ilg_noise(coord*resolution_nrml)*0.1 + 0.9, lum) *temp;
                }
                col /= ceil((distance - 1.)/.05);
                return col;
            }
            void main() {
                vec2 lightDir = lightTarget - lightPos;
                vec3 col = radialBlur(previous, fragCoord, lightDir, 2.);//*0.5 + texture(previous, fragCoord).xyz;;
                fragColor.xyz = col;
                fragColor.w = 1.;
            }
        </script>
        <style type="text/css">
            body{
                margin : 0px ;
                padding : 0px ;
            }
            body #wrapper{
                width: 100%;
                height: 100%;
                position: fixed;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <canvas id="canvas"></canvas>
        </div>
    </body>
</html>